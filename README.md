# 3D Building Mesh Generation Pipeline

3D ν¬μΈνΈ ν΄λΌμ°λ“μ—μ„ κ±΄λ¬Όμ μ™„μ „ν• 3D λ©”μ‰¬λ¥Ό μƒμ„±ν•λ” νμ΄ν”„λΌμΈμ…λ‹λ‹¤.

## π“ ν”„λ΅μ νΈ κµ¬μ΅°

```
Individual-Research/
β”β”€β”€ input/                          # μ…λ ¥ νμΌ
β”‚   β”β”€β”€ 3BP_CS_model_Cloud.pcd     # μ›λ³Έ ν¬μΈνΈ ν΄λΌμ°λ“
β”‚   β””β”€β”€ 3BP_CS_model.ply           # μ›λ³Έ λ©”μ‰¬
β”β”€β”€ script/                         # μ‹¤ν–‰ μ¤ν¬λ¦½νΈ
β”‚   β”β”€β”€ nonowall.py                # λ²½ μ κ±°
β”‚   β”β”€β”€ ransac.py                  # λ°”λ‹¥ ν‰λ©΄ λ¶„λ¦¬
β”‚   β”β”€β”€ outline.py                 # 2D μ¤κ³½μ„  μ¶”μ¶
β”‚   β”β”€β”€ morph.py                   # ν•νƒν•™μ  μ²λ¦¬
β”‚   β”β”€β”€ pcd_to_mesh.py             # 3D λ©”μ‰¬ μƒμ„±
β”‚   β””β”€β”€ run_full_pipeline.py       # μ „μ²΄ νμ΄ν”„λΌμΈ μ‹¤ν–‰
β”β”€β”€ output/                         # μ¶λ ¥ κ²°κ³Ό
β”‚   β”β”€β”€ nonowall.pcd               # λ²½ μ κ±°λ PCD
β”‚   β”β”€β”€ ransac/                    # RANSAC κ²°κ³Ό
β”‚   β”β”€β”€ outline/                   # 2D μ¤κ³½μ„ 
β”‚   β”β”€β”€ morph/                     # ν•νƒν•™ μ²λ¦¬ κ²°κ³Ό
β”‚   β”β”€β”€ pcd/                       # μµμΆ… PCD νμΌ
β”‚   β””β”€β”€ mesh/                      # μµμΆ… λ©”μ‰¬ νμΌ
β””β”€β”€ requirements.txt               # ν•„μ”ν• ν¨ν‚¤μ§€
```

## π€ μ‹¤ν–‰ λ°©λ²•

### μ „μ²΄ νμ΄ν”„λΌμΈ μ‹¤ν–‰:
```bash
cd script
python run_full_pipeline.py
```

### κ°λ³„ λ‹¨κ³„ μ‹¤ν–‰:
```bash
cd script
python nonowall.py    # 1λ‹¨κ³„: λ²½ μ κ±°
python ransac.py      # 2λ‹¨κ³„: λ°”λ‹¥ ν‰λ©΄ λ¶„λ¦¬
python outline.py     # 3λ‹¨κ³„: 2D μ¤κ³½μ„  μ¶”μ¶
python morph.py       # 4λ‹¨κ³„: ν•νƒν•™μ  μ²λ¦¬
python morph_to_pcd.py # 5λ‹¨κ³„: 
python pcd_to_mesh.py # 6λ‹¨κ³„: 3D λ©”μ‰¬ μƒμ„±
```

## π”¬ κ° κ³Όμ •μ μ›λ¦¬μ™€ μ‘λ™ κ³Όμ •

### 1. **nonowall.py - λ²½ μ κ±° (Wall Removal)**

#### **μ›λ¦¬:**
- κ±΄λ¬Όμ μ™Έλ²½μ„ μ κ±°ν•μ—¬ λ‚΄λ¶€ κµ¬μ΅°λ§ λ‚¨κΈ°λ” κ³Όμ •
- λ°•μ¤ ν•„ν„°λ§ κΈ°λ°μΌλ΅ κ²½κ³„ μμ—­μ μ λ“¤μ„ μ κ±°

#### **μ‘λ™ κ³Όμ •:**
1. **ν¬μΈνΈ ν΄λΌμ°λ“ λ΅λ“**: `input/3BP_CS_model_Cloud.pcd` λ΅λ“
2. **κ²½κ³„ μμ—­ μ‹λ³„**: X, Z λ°©ν–¥μ κ²½κ³„μ—μ„ κ°€μ¥ λ°€λ„κ°€ λ†’μ€ μμ—­ νƒμ§€
3. **λ°•μ¤ ν•„ν„°λ§**: 
   - κ²½κ³„ λ‘κ»: 9.0m
   - μƒμ„ 2κ° λ°©ν–¥ μ„ νƒ (μ: 'z-', 'z+')
   - ν•΄λ‹Ή μμ—­μ μ λ“¤μ„ λ²½μΌλ΅ μ‹λ³„
4. **λ²½ μ κ±°**: λ²½μΌλ΅ μ‹λ³„λ μ λ“¤μ„ μ κ±°
5. **λ‹¤μ΄μƒν”λ§**: voxel_size=0.03μΌλ΅ λ‹¤μ΄μƒν”λ§
6. **κ²°κ³Ό μ €μ¥**: `output/nonowall.pcd`

#### **ν•µμ‹¬ νλΌλ―Έν„°:**
- `boundary_thickness`: 9.0m (λ²½ λ‘κ»)
- `voxel_size`: 0.03 (λ‹¤μ΄μƒν”λ§ ν¬κΈ°)

---

### 2. **ransac.py - RANSAC λ°”λ‹¥ ν‰λ©΄ λ¶„λ¦¬**

#### **μ›λ¦¬:**
- RANSAC (Random Sample Consensus) μ•κ³ λ¦¬μ¦μ„ μ‚¬μ©ν•μ—¬ λ‹¤μ¤‘ ν‰λ©΄ κ²€μ¶
- Yμ¶•κ³Ό ν‰ν–‰ν• ν‰λ©΄λ“¤μ„ λ°”λ‹¥μΌλ΅ μ‹λ³„
- λ°”λ‹¥ μμ—­μ„ ν™•μ¥ν•μ—¬ λ°”λ‹¥κ³Ό κ°μ²΄ κ°„μ μ—°κ²° λ¶€λ¶„ μ κ±°

#### **μ‘λ™ κ³Όμ •:**
1. **ν¬μΈνΈ ν΄λΌμ°λ“ λ΅λ“**: `output/nonowall.pcd` λ΅λ“
2. **RANSAC ν‰λ©΄ κ²€μ¶**:
   - μµλ€ 40κ° ν‰λ©΄ κ²€μ¶
   - `distance_threshold`: 0.02m (ν‰λ©΄ μ •λ°€λ„)
   - `ransac_n`: 3 (μµμ† μƒν” μ)
   - `num_iterations`: 1000 (λ°λ³µ νμ)
3. **λ°”λ‹¥ ν‰λ©΄ μ‹λ³„**:
   - Yμ¶•κ³Όμ κ°λ„κ°€ 30λ„ μ΄ν•μΈ ν‰λ©΄μ„ λ°”λ‹¥μΌλ΅ μ‹λ³„
   - λ²•μ„  λ²΅ν„°μ™€ Yμ¶• [0,1,0] κ°„μ κ°λ„ κ³„μ‚°
4. **λ°”λ‹¥ μμ—­ ν™•μ¥**:
   - `vertical_offset`: 1.5m (λ°”λ‹¥ μμ—­ μ„λ΅ ν™•μ¥)
   - λ°”λ‹¥κ³Ό κ°μ²΄ κ°„μ μ§€μ €λ¶„ν• μ—°κ²° λ¶€λ¶„ μ κ±°
5. **κ²°κ³Ό μ €μ¥**:
   - `output/ransac/floor_plane.pcd`: λ°”λ‹¥ ν‰λ©΄
   - `output/ransac/above_floor.pcd`: λ°”λ‹¥ μ„ μμ—­

#### **ν•µμ‹¬ νλΌλ―Έν„°:**
- `max_planes`: 40 (μµλ€ ν‰λ©΄ μ)
- `distance_threshold`: 0.02m
- `vertical_offset`: 1.5m (λ°”λ‹¥ μμ—­ ν™•μ¥)

---

### 3. **outline.py - 2D μ¤κ³½μ„  μ¶”μ¶**

#### **μ›λ¦¬:**
- 3D ν¬μΈνΈ ν΄λΌμ°λ“λ¥Ό Yμ¶• μ„μ½μ—μ„ λ°”λΌλ³΄λ” 2D ν¬μ
- DBSCAN ν΄λ¬μ¤ν„°λ§μΌλ΅ λ…Έμ΄μ¦ μ κ±° λ° κ°μ²΄ λ¶„λ¦¬
- μ»¨ν¬μ–΄ μ¶”μ¶μ„ ν†µν• 2D μ¤κ³½μ„  μƒμ„±

#### **μ‘λ™ κ³Όμ •:**
1. **ν¬μΈνΈ ν΄λΌμ°λ“ λ΅λ“**: `output/ransac/above_floor.pcd`, `output/ransac/floor_plane.pcd`
2. **2D ν¬μ**:
   - Yμ¶• μ„μ½μ—μ„ λ°”λΌλ³΄κΈ° μ„ν•΄ X-Z ν‰λ©΄μΌλ΅ ν¬μ
   - 3D μΆν‘ (x,y,z) β†’ 2D μΆν‘ (x,z)
3. **μ¤μΌ€μΌλ§**: μ μ ν• μ΄λ―Έμ§€ ν¬κΈ°λ¥Ό μ„ν• μ¤μΌ€μΌ ν©ν„° κ³„μ‚°
4. **DBSCAN ν΄λ¬μ¤ν„°λ§**:
   - λ…Έμ΄μ¦ μ κ±° (label = -1μΈ μ λ“¤)
   - κ°μ²΄ λ¶„λ¦¬ λ° ν΄λ¬μ¤ν„°λ§
   - νλΌλ―Έν„°: `eps=1.5`, `min_samples=15`
5. **μ»¨ν¬μ–΄ μ¶”μ¶**:
   - κ° ν΄λ¬μ¤ν„°λ³„λ΅ μ΄μ§„ μ΄λ―Έμ§€ μƒμ„±
   - `cv2.findContours`λ΅ μ¤κ³½μ„  μ¶”μ¶
   - λ©΄μ  ν•„ν„°λ§ λ° κ·Όμ‚¬ν™”
6. **κ²°κ³Ό μ €μ¥**:
   - `output/outline/top_view/binary.png`: μ΄μ§„ μ΄λ―Έμ§€
   - `output/outline/top_view/contours.png`: μ¤κ³½μ„  μ΄λ―Έμ§€
   - `output/outline/top_view/pixel_to_points.pkl`: ν”½μ…€-3Dμ  λ§¤ν•‘

#### **ν•µμ‹¬ νλΌλ―Έν„°:**
- `scale_factor`: 5 (μ΄λ―Έμ§€ μ¤μΌ€μΌ)
- `dbscan_eps`: 1.5 (ν΄λ¬μ¤ν„°λ§ κ±°λ¦¬)
- `min_contour_area`: 60 (μµμ† μ»¨ν¬μ–΄ λ©΄μ )

---

### 4. **morph.py - ν•νƒν•™μ  μ²λ¦¬**

#### **μ›λ¦¬:**
- OpenCVμ ν•νƒν•™μ  μ—°μ‚°μ„ μ‚¬μ©ν•μ—¬ μ¤κ³½μ„ μ„ λ¶€λ“λ½κ² μ²λ¦¬
- μΉ¨μ‹(Erosion)κ³Ό ν½μ°½(Dilation)μ„ μ΅°ν•©ν•μ—¬ λ…Έμ΄μ¦ μ κ±°

#### **μ‘λ™ κ³Όμ •:**
1. **μ΄μ§„ μ΄λ―Έμ§€ λ΅λ“**: `output/outline/*/binary.png`
2. **μΉ¨μ‹(Erosion)**:
   - `cv2.erode`λ΅ κ²½κ³„λ¥Ό μ¶•μ†
   - λ…Έμ΄μ¦ μ κ±° ν¨κ³Ό
3. **ν½μ°½(Dilation)**:
   - `cv2.dilate`λ΅ κ²½κ³„λ¥Ό ν™•μ¥
   - μΉ¨μ‹ ν›„ ν½μ°½μΌλ΅ κ²½κ³„ μ„ λ…ν™”
4. **μ—΄λ¦Ό-λ‹«ν μ—°μ‚°**:
   - `cv2.MORPH_OPEN`: μΉ¨μ‹ ν›„ ν½μ°½ (λ…Έμ΄μ¦ μ κ±°)
   - `cv2.MORPH_CLOSE`: ν½μ°½ ν›„ μΉ¨μ‹ (κµ¬λ© λ©”μ°κΈ°)
5. **κ²°κ³Ό μ €μ¥**: `output/morph/*/morph_smoothed.png`

#### **ν•µμ‹¬ νλΌλ―Έν„°:**
- `kernel_size`: 5 (ν•νƒν•™ μ—°μ‚° μ»¤λ„ ν¬κΈ°)
- `iterations`: 2 (λ°λ³µ νμ)

---

### 5. **pcd_to_mesh.py - 3D λ©”μ‰¬ μƒμ„±**

#### **μ›λ¦¬:**
- 2D μ¤κ³½μ„ μ„ 3D λ©”μ‰¬λ΅ λ³€ν™
- λ°”λ‹¥, μ²μ¥, λ²½μ„ κ°κ° μƒμ„± ν›„ λ³‘ν•©
- Delaunay μ‚Όκ°λ¶„ν• κ³Ό μ¤κ³½μ„  μ μ•½ μ΅°κ±΄μ„ μ‚¬μ©

#### **μ‘λ™ κ³Όμ •:**
1. **μ΄λ―Έμ§€ λ΅λ“**: `output/morph/top_view/morph_smoothed.png`
2. **μ¤κ³½μ„  μ¶”μ¶**:
   - `cv2.findContours`λ΅ μ¤κ³½μ„  μ¶”μ¶
   - `cv2.approxPolyDP`λ΅ κ·Όμ‚¬ν™”
3. **μΆν‘ λ³€ν™**:
   - ν”½μ…€ μΆν‘λ¥Ό 3D μ›”λ“ μΆν‘λ΅ λ³€ν™
   - `pixel_to_points.pkl` νμΌμ„ μ‚¬μ©ν• μ •ν™•ν• λ§¤ν•‘
4. **λ°”λ‹¥ λ©”μ‰¬ μƒμ„±**:
   - Poisson λ©”μ‰¬ μƒμ„±: `output/pcd/final_result_floor_plane.pcd`
   - λ°”λ‹¥ Y λ λ²¨ κ°μ§€
5. **μ²μ¥/λ°”λ‹¥ λ©”μ‰¬ μƒμ„±**:
   - `create_constrained_flat_mesh` ν•¨μ μ‚¬μ©
   - Delaunay μ‚Όκ°λ¶„ν•  + μ¤κ³½μ„  μ μ•½ μ΅°κ±΄
   - λ°”λ‹¥: Y = floor_y_level + z_fighting_offset
   - μ²μ¥: Y = floor_y_level + fixed_height + z_fighting_offset
6. **λ²½ λ©”μ‰¬ μƒμ„±**:
   - μ¤κ³½μ„ μ„ Yμ¶• λ°©ν–¥μΌλ΅ μ••μ¶(Extrusion)
   - λ°”λ‹¥μ—μ„ μ²μ¥κΉμ§€μ μμ§ λ²½ μƒμ„±
7. **λ©”μ‰¬ λ³‘ν•©**:
   - λ°”λ‹¥ + μ²μ¥ + λ²½ λ©”μ‰¬ λ³‘ν•©
   - μµμΆ… κ²°κ³Ό: `output/pcd/extruded_building_mesh.ply`
8. **μ‹κ°ν™”**: Open3Dλ¥Ό μ‚¬μ©ν• 3D λ©”μ‰¬ μ‹κ°ν™”

#### **ν•µμ‹¬ νλΌλ―Έν„°:**
- `fixed_height`: 10.0m (κ±΄λ¬Ό λ†’μ΄)
- `z_fighting_offset`: 0.001m (Z-fighting λ°©μ§€)
- `sphere_radius`: 1.0m (λ””λ²„κ·Έ κµ¬ ν¬κΈ°)

---

## π“ μ¶λ ¥ νμΌ μ„¤λ…

### **μ¤‘κ°„ κ²°κ³Ό:**
- `output/nonowall.pcd`: λ²½μ΄ μ κ±°λ ν¬μΈνΈ ν΄λΌμ°λ“
- `output/ransac/floor_plane.pcd`: λ°”λ‹¥ ν‰λ©΄ ν¬μΈνΈ ν΄λΌμ°λ“
- `output/ransac/above_floor.pcd`: λ°”λ‹¥ μ„ μμ—­ ν¬μΈνΈ ν΄λΌμ°λ“
- `output/outline/*/binary.png`: 2D μ΄μ§„ ν¬μ μ΄λ―Έμ§€
- `output/outline/*/pixel_to_points.pkl`: ν”½μ…€-3Dμ  λ§¤ν•‘ ν…μ΄λΈ”
- `output/morph/*/morph_smoothed.png`: ν•νƒν•™ μ²λ¦¬λ μ΄λ―Έμ§€

### **μµμΆ… κ²°κ³Ό:**
- `output/pcd/extruded_building_mesh.ply`: μ™„μ „ν• 3D κ±΄λ¬Ό λ©”μ‰¬
- `output/mesh/merged_result_solid.ply`: λ°”λ‹¥κ³Ό λ³‘ν•©λ λ©”μ‰¬
- `output/coordinate_mapping.json`: μΆν‘ λ§¤ν•‘ μ •λ³΄

## π”§ μ£Όμ” μ•κ³ λ¦¬μ¦

### **RANSAC (Random Sample Consensus)**
- λ…Έμ΄μ¦κ°€ μλ” λ°μ΄ν„°μ—μ„ μν•™μ  λ¨λΈμ„ μ°Ύλ” λ°λ³µμ  λ°©λ²•
- ν‰λ©΄ κ²€μ¶μ— μ‚¬μ©ν•μ—¬ λ°”λ‹¥ ν‰λ©΄μ„ μ‹λ³„

### **DBSCAN (Density-Based Spatial Clustering)**
- λ°€λ„ κΈ°λ° ν΄λ¬μ¤ν„°λ§ μ•κ³ λ¦¬μ¦
- 2D ν¬μμ—μ„ λ…Έμ΄μ¦ μ κ±° λ° κ°μ²΄ λ¶„λ¦¬μ— μ‚¬μ©

### **Delaunay μ‚Όκ°λ¶„ν• **
- μ  μ§‘ν•©μ„ μ‚Όκ°ν•μΌλ΅ λ¶„ν• ν•λ” μ•κ³ λ¦¬μ¦
- 2D μ¤κ³½μ„ μ„ 3D λ©”μ‰¬λ΅ λ³€ν™ν•  λ• μ‚¬μ©

### **ν•νƒν•™μ  μ—°μ‚°**
- μΉ¨μ‹(Erosion): κ²½κ³„ μ¶•μ†, λ…Έμ΄μ¦ μ κ±°
- ν½μ°½(Dilation): κ²½κ³„ ν™•μ¥, κµ¬λ© λ©”μ°κΈ°
- μ—΄λ¦Ό(Opening): μΉ¨μ‹ ν›„ ν½μ°½
- λ‹«ν(Closing): ν½μ°½ ν›„ μΉ¨μ‹

## π“‹ μ‹μ¤ν… μ”κµ¬μ‚¬ν•­

### **Python ν¨ν‚¤μ§€:**
```
open3d>=0.17.0
numpy>=1.21.0
opencv-python>=4.5.0
scikit-learn>=1.0.0
matplotlib>=3.5.0
```

### **μ„¤μΉ:**
```bash
pip install -r requirements.txt
```

## π― μ‚¬μ© ν

1. **μ…λ ¥ νμΌ**: `input/` ν΄λ”μ— PCD νμΌμ„ λ„£μ–΄μ£Όμ„Έμ”
2. **λ©”λ¨λ¦¬**: λ€μ©λ‰ ν¬μΈνΈ ν΄λΌμ°λ“μ κ²½μ° μ¶©λ¶„ν• RAM ν•„μ”
3. **GPU**: Open3D μ‹κ°ν™”λ” GPU κ°€μ† μ§€μ›
4. **νλΌλ―Έν„° μ΅°μ •**: κ° μ¤ν¬λ¦½νΈμ νλΌλ―Έν„°λ¥Ό λ°μ΄ν„°μ— λ§κ² μ΅°μ • κ°€λ¥

## π” λ¬Έμ  ν•΄κ²°

### **μΌλ°μ μΈ λ¬Έμ :**
- **λ©”λ¨λ¦¬ λ¶€μ΅±**: ν¬μΈνΈ ν΄λΌμ°λ“ λ‹¤μ΄μƒν”λ§ νλΌλ―Έν„° μ΅°μ •
- **μ¤κ³½μ„  λ¶€μ •ν™•**: DBSCAN νλΌλ―Έν„° μ΅°μ •
- **λ©”μ‰¬ ν’μ§**: Delaunay μ‚Όκ°λ¶„ν•  νλΌλ―Έν„° μ΅°μ •

### **Windows νΈν™μ„±:**
- λ¨λ“  μ¤ν¬λ¦½νΈλ” Windowsμ—μ„ ν…μ¤νΈλ¨
- μ λ‹μ½”λ“ μ΄λ¨μ§€ μ κ±°λ΅ μΈμ½”λ”© λ¬Έμ  ν•΄κ²°
- cp949 μΈμ½”λ”© μ§€μ›
